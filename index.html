<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monad Paint üé®</title>
    <!-- Tailwind CSS CDN for a modern, utility-first approach -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts for a clean, professional look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Ethers.js for wallet and smart contract interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            /* Custom colors using Tailwind's naming convention for consistency */
            --color-monad-blue-500: #6366f1; /* Main accent color */
            --color-monad-blue-400: #818cf8; /* Hover accent color */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: white;
            padding-bottom: 4rem; /* Space for the fixed footer */
        }
        /* Custom styles for the pixel grid */
        #canvas {
            display: grid;
            grid-template-columns: repeat(20, minmax(0, 1fr));
            gap: 2px;
        }
        .pixel {
            aspect-ratio: 1 / 1; /* Keep pixels square */
            background-color: #1f1f1f;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s ease-in-out, background-color 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .pixel:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        /* Style for the color input */
        #colorPicker::-webkit-color-swatch-wrapper { padding: 0; }
        #colorPicker::-webkit-color-swatch { border: none; border-radius: 6px; }
        #colorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 2px solid #555;
            width: 48px;
            height: 48px;
            cursor: pointer;
            border-radius: 8px;
        }
        /* Hide the default number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        /* Utility for hiding elements */
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-[#0d0d0d] flex flex-col items-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="max-w-4xl w-full flex flex-col items-center gap-6">
        
        <!-- Header Section -->
        <header class="w-full flex justify-between items-center bg-[#0d0d0d] py-2 px-4 sticky top-0 z-10">
            <div class="flex items-center space-x-3">
                <img class="h-10 w-auto" src="https://docs.monad.xyz/img/monad_logo.png" alt="Monad Logo" />
                <h1 class="text-3xl font-bold text-monad-blue-500">Monad Paint üé®</h1>
            </div>
            <a href="https://mon-flip.vercel.app/" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-monad-blue-500 hover:bg-monad-blue-400 text-white font-semibold text-sm rounded-lg shadow-md transition-colors duration-200">
                PLAY MonFLIP
            </a>
        </header>

        <!-- Controls & Status Card -->
        <div class="w-full max-w-2xl bg-[#1a1a1a] p-6 rounded-2xl shadow-xl flex flex-col sm:flex-row items-center justify-between gap-4">
            <!-- Connection & Balance Group -->
            <div class="flex items-center gap-4 flex-wrap">
                <button id="connect" class="px-6 py-3 bg-monad-blue-500 hover:bg-monad-blue-400 text-white font-semibold rounded-lg shadow-md transition-transform duration-200 active:scale-95">
                    Connect Wallet
                </button>
                <button id="disconnect" class="hidden px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg shadow-md transition-transform duration-200 active:scale-95">
                    Disconnect
                </button>
            </div>
            
            <!-- Color Picker & Status Group -->
            <div class="flex flex-col sm:flex-row items-center gap-4 mt-4 sm:mt-0">
                <div class="flex items-center gap-2">
                    <label for="colorPicker" class="text-gray-300 font-medium">Color:</label>
                    <input type="color" id="colorPicker" value="#ff0000" title="Select color" />
                </div>
            </div>
        </div>

        <!-- Status & Balance Display -->
        <div class="w-full max-w-2xl flex flex-col items-center">
            <p id="status" class="text-gray-400 text-center font-medium min-h-[1.5em] px-4 break-words">Status: Not connected</p>
            <p id="balance" class="text-gray-300 text-center font-semibold text-lg mt-2"></p>
        </div>

        <!-- Main Canvas -->
        <div id="canvas-container" class="w-full max-w-[calc(20*24px+21*2px)] bg-[#1a1a1a] p-4 rounded-2xl shadow-xl">
            <div id="canvas" class="w-full max-w-full mx-auto"></div>
        </div>
    </div>

    <!-- Fixed Bottom Footer -->
    <footer class="fixed bottom-0 left-0 w-full bg-[#131313] bg-opacity-95 backdrop-blur-sm shadow-2xl p-3 flex justify-center items-center text-sm z-50">
        <div class="flex items-center gap-4">
            <a href="https://twitter.com/lemonar777" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-monad-blue-400 transition-colors duration-200 flex items-center gap-2">
                <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.46 6c-.77.35-1.6.58-2.46.69a4.3 4.3 0 0 0 1.88-2.38 8.59 8.59 0 0 1-2.72 1.04A4.28 4.28 0 0 0 11.1 9.03 12.14 12.14 0 0 1 3 5.3a4.28 4.28 0 0 0 1.32 5.71A4.25 4.25 0 0 1 2.8 10v.05a4.28 4.28 0 0 0 3.43 4.2 4.28 4.28 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.97A8.6 8.6 0 0 1 2 19.54a12.14 12.14 0 0 0 6.56 1.92c7.88 0 12.2-6.53 12.2-12.2v-.56A8.6 8.6 0 0 0 24 5.5a8.48 8.48 0 0 1-2.54.7z"/>
                </svg>
                Made with ‚ù§Ô∏è for MONAD by @lemonar777
            </a>
            <button id="donateButton" class="px-4 py-1 border-2 border-monad-blue-500 text-monad-blue-500 font-semibold rounded-full hover:bg-monad-blue-500 hover:text-white transition-colors duration-200">
                Donate MON
            </button>
        </div>
    </footer>

    <!-- Custom Modal for Alerts and Donations -->
    <div id="customModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div id="modalContent" class="bg-[#1a1a1a] text-white p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
            <p id="modalMessage" class="text-gray-300 mb-6"></p>
            <div id="modalControls" class="flex justify-end gap-3">
                <!-- Buttons will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Script Section -->
    <script>
        // Contract details (unchanged)
        const contractAddress = "0x5CF8586bbe054980352C93E783E3c0bE319b9A3a";
        const abi = [
            { "anonymous": false, "inputs": [ { "indexed": false, "internalType": "uint256", "name": "x", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "y", "type": "uint256" }, { "indexed": false, "internalType": "uint32", "name": "color", "type": "uint32" } ], "name": "PixelSet", "type": "event" },
            { "inputs": [], "name": "HEIGHT", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "WIDTH", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" },
            { "inputs": [ { "internalType": "uint256", "name": "x", "type": "uint256" }, { "internalType": "uint256", "name": "y", "type": "uint256" } ], "name": "getPixel", "outputs": [ { "internalType": "uint32", "name": "", "type": "uint32" } ], "stateMutability": "view", "type": "function" },
            { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "pixels", "outputs": [ { "internalType": "uint32", "name": "", "type": "uint32" } ], "stateMutability": "view", "type": "function" },
            { "inputs": [ { "internalType": "uint256", "name": "x", "type": "uint256" }, { "internalType": "uint256", "name": "y", "type": "uint256" }, { "internalType": "uint32", "name": "color", "type": "uint32" } ], "name": "setPixel", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        // UI element references
        const connectBtn = document.getElementById("connect");
        const disconnectBtn = document.getElementById("disconnect");
        const statusEl = document.getElementById("status");
        const balanceEl = document.getElementById("balance");
        const canvas = document.getElementById("canvas");
        const colorPicker = document.getElementById("colorPicker");
        const donateButton = document.getElementById("donateButton");

        // Custom Modal elements
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalControls = document.getElementById('modalControls');

        // Global state variables
        let provider = null;
        let signer = null;
        let contract = null;
        let isPainting = false;

        // Custom alert function to replace window.alert
        function customAlert(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalControls.innerHTML = `
                <button id="modalCloseBtn" class="px-4 py-2 font-semibold rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors duration-200">
                    Close
                </button>
            `;
            customModal.classList.remove('hidden');
            document.getElementById('modalCloseBtn').onclick = () => customModal.classList.add('hidden');
        }

        // Custom function to show a donation modal
        function showDonateModal() {
            modalTitle.textContent = "Donate MON";
            modalMessage.innerHTML = `
                <p class="mb-4">Enter an amount in MON to send a donation to the developer.</p>
                <input id="donationAmount" type="number" min="0" step="0.0001" placeholder="Amount (MON)" class="w-full p-2 rounded-md bg-[#2d2d2d] text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-monad-blue-500" />
                <p id="donateStatus" class="mt-2 min-h-[1.5em] text-sm text-gray-400"></p>
            `;
            modalControls.innerHTML = `
                <button id="cancelDonate" class="px-4 py-2 font-semibold rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors duration-200">
                    Cancel
                </button>
                <button id="confirmDonate" class="px-4 py-2 font-semibold rounded-lg bg-monad-blue-500 text-white hover:bg-monad-blue-400 transition-colors duration-200">
                    Send
                </button>
            `;
            customModal.classList.remove('hidden');

            document.getElementById('cancelDonate').onclick = () => customModal.classList.add('hidden');
            document.getElementById('confirmDonate').onclick = handleDonation;
        }

        // --- Wallet Connection & Interaction Logic ---

        function getInjectedProvider() {
            if (window.ethereum?.providers?.length) {
                const metamask = window.ethereum.providers.find(p => p.isMetaMask);
                return metamask || window.ethereum.providers[0];
            }
            return window.ethereum || null;
        }

        async function switchToMonadTestnet(injectedProvider) {
            const chainIdHex = "0x279f"; // 10143 decimal
            try {
                await injectedProvider.request({ method: "wallet_switchEthereumChain", params: [{ chainId: chainIdHex }] });
                console.log("Switched to Monad Testnet");
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await injectedProvider.request({
                            method: "wallet_addEthereumChain",
                            params: [{
                                chainId: chainIdHex,
                                chainName: "Monad Testnet",
                                nativeCurrency: { name: "Monad", symbol: "MON", decimals: 18 },
                                rpcUrls: ["https://testnet-rpc.monad.xyz"],
                                blockExplorerUrls: ["https://testnet.monadexplorer.com"]
                            }]
                        });
                        await injectedProvider.request({ method: "wallet_switchEthereumChain", params: [{ chainId: chainIdHex }] });
                        console.log("Added and switched to Monad Testnet");
                        return true;
                    } catch (addError) {
                        customAlert("Network Error", "Failed to add the Monad Testnet network to your wallet.");
                        return false;
                    }
                } else {
                    customAlert("Network Error", "Failed to switch to Monad Testnet. Please do so manually.");
                    return false;
                }
            }
        }

        async function connectWallet() {
            const injectedProvider = getInjectedProvider();
            if (!injectedProvider) {
                customAlert("No Wallet Found", "No EVM-compatible wallet found. Please install MetaMask or similar.");
                return;
            }

            connectBtn.disabled = true;
            connectBtn.textContent = "Connecting...";
            statusEl.textContent = "Requesting wallet connection...";

            try {
                await injectedProvider.request({ method: "eth_requestAccounts" });
                const switched = await switchToMonadTestnet(injectedProvider);
                if (!switched) {
                    connectBtn.disabled = false;
                    connectBtn.textContent = "Connect Wallet";
                    return;
                }

                provider = new ethers.providers.Web3Provider(injectedProvider);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, abi, signer);

                const address = await signer.getAddress();
                const balance = await provider.getBalance(address);
                const monBalance = ethers.utils.formatEther(balance);

                statusEl.textContent = `Connected: ${address.slice(0,6)}...${address.slice(-4)}`;
                balanceEl.textContent = `Balance: ${parseFloat(monBalance).toFixed(4)} MON`;

                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');

                await loadPixels();

                contract.on("PixelSet", (x, y, color) => {
                    const num = color.toNumber ? color.toNumber() : parseInt(color);
                    if (num !== 0) {
                        const hexColor = "#" + num.toString(16).padStart(6, "0");
                        const pixel = canvas.querySelector(`.pixel[data-x='${x}'][data-y='${y}']`);
                        if (pixel) {
                            pixel.style.backgroundColor = hexColor;
                            statusEl.textContent = `Pixel updated at (${x}, ${y})`;
                        }
                    }
                });

            } catch (err) {
                console.error("Connection failed:", err);
                statusEl.textContent = "Connection cancelled or failed.";
                connectBtn.disabled = false;
                connectBtn.textContent = "Connect Wallet";
            }
        }

        function disconnectWallet() {
            if(contract) contract.removeAllListeners("PixelSet");
            provider = null;
            signer = null;
            contract = null;
            isPainting = false;

            statusEl.textContent = "Disconnected";
            balanceEl.textContent = "";
            connectBtn.classList.remove('hidden');
            disconnectBtn.classList.add('hidden');

            canvas.querySelectorAll(".pixel").forEach(pixel => {
                pixel.style.backgroundColor = "#1f1f1f";
            });
        }

        async function handlePixelClick(event) {
            if (!contract) {
                customAlert("Not Connected", "Please connect your wallet first.");
                return;
            }
            if (isPainting) {
                statusEl.textContent = "Please wait for previous transaction to finish.";
                return;
            }

            const x = event.target.dataset.x;
            const y = event.target.dataset.y;
            const colorHex = colorPicker.value;
            const colorInt = parseInt(colorHex.slice(1), 16);

            try {
                isPainting = true;
                statusEl.textContent = `Setting pixel (${x}, ${y})...`;

                const tx = await contract.setPixel(x, y, colorInt, { gasLimit: 150000 });
                statusEl.textContent = `Transaction sent: ${tx.hash}`;
                await tx.wait();

                // Pixel color will be updated by the `PixelSet` event listener
                statusEl.textContent = `Pixel set at (${x}, ${y}) - Tx confirmed`;
            } catch (err) {
                console.error(err);
                let msg = "Transaction failed or rejected.";
                if (err.data?.message) msg = err.data.message;
                else if (err.error?.message) msg = err.error.message;
                else if (err.message) msg = err.message;
                customAlert("Transaction Error", msg);
            } finally {
                isPainting = false;
            }
        }

        async function loadPixels() {
            if (!contract) return;
            statusEl.textContent = "Loading canvas pixels...";
            const promises = [];
            for (let y = 0; y < 20; y++) {
                for (let x = 0; x < 20; x++) {
                    promises.push(
                        contract.getPixel(x, y)
                            .then(colorInt => {
                                const num = colorInt.toNumber ? colorInt.toNumber() : parseInt(colorInt);
                                if (num !== 0) {
                                    const hexColor = "#" + num.toString(16).padStart(6, "0");
                                    const pixel = canvas.querySelector(`.pixel[data-x='${x}'][data-y='${y}']`);
                                    if (pixel) pixel.style.backgroundColor = hexColor;
                                }
                            })
                            .catch(err => console.warn(`Failed to load pixel (${x},${y})`, err))
                    );
                }
            }
            await Promise.all(promises);
            statusEl.textContent = "Canvas loaded.";
        }

        // --- Donate Functionality ---
        const myAddress = "0x90FBd5371e02FD1E43a9803cD18a87Aad1AeA434"; // Developer's address

        async function handleDonation() {
            const donationAmountInput = document.getElementById("donationAmount");
            const donateStatus = document.getElementById("donateStatus");
            const confirmDonate = document.getElementById('confirmDonate');
            
            const amount = donationAmountInput.value.trim();

            if (!provider || !signer) {
                donateStatus.textContent = "Please connect your wallet first.";
                return;
            }

            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                donateStatus.textContent = "Enter a valid amount > 0";
                return;
            }

            try {
                confirmDonate.disabled = true;
                confirmDonate.textContent = "Sending...";
                donateStatus.textContent = "Sending transaction...";

                const tx = await signer.sendTransaction({
                    to: myAddress,
                    value: ethers.utils.parseEther(amount)
                });

                donateStatus.textContent = `Transaction sent: ${tx.hash}`;
                await tx.wait();

                donateStatus.textContent = `Thank you for your donation! Tx confirmed.`;
                donationAmountInput.value = "";
            } catch (err) {
                console.error(err);
                donateStatus.textContent = "Transaction failed or rejected.";
            } finally {
                confirmDonate.disabled = false;
                confirmDonate.textContent = "Send";
            }
        }

        // --- Event Listeners and Initialization ---

        window.onload = () => {
            // Generate the pixel grid
            for (let y = 0; y < 20; y++) {
                for (let x = 0; x < 20; x++) {
                    const pixel = document.createElement("div");
                    pixel.className = "pixel";
                    pixel.dataset.x = x;
                    pixel.dataset.y = y;
                    pixel.onclick = handlePixelClick;
                    canvas.appendChild(pixel);
                }
            }
        };

        connectBtn.onclick = connectWallet;
        disconnectBtn.onclick = disconnectWallet;
        donateButton.onclick = showDonateModal;

        // Handle wallet account/chain changes
        if (window.ethereum) {
            window.ethereum.on("accountsChanged", () => {
                statusEl.textContent = "Account changed. Please reconnect.";
                disconnectWallet();
            });
            window.ethereum.on("chainChanged", () => {
                statusEl.textContent = "Chain changed. Please reconnect.";
                disconnectWallet();
            });
        }
    </script>
</body>
</html>
